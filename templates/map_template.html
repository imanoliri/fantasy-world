<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>World: {{ map_name }}</title>
    <link rel="stylesheet" href="../map.css">
</head>

<body class="show-capitals show-food-trades show-gold-trades">
    <header>
        <h1>World: {{ map_name }}</h1>
        <div class="controls">
            <input type="text" id="searchInput" onkeyup="filterTable()" placeholder="Search names...">

            <div class="dropdown">
                <button class="dropbtn" onclick="toggleDropdown('typeDropdown')">Filter Types ‚ñº</button>
                <div class="dropdown-content" id="typeDropdown">
                    <div class="checkbox-list" id="typeCheckboxes">
                        <label><input type="checkbox" value="all" checked onchange="toggleAllTypes(this)"> All
                            Types</label>
                        {% for t in burg_types %}
                        <label><input type="checkbox" value="{{ t }}" checked onchange="filterTable()"> {{ t }}</label>
                        {% endfor %}
                        <label><input type="checkbox" value="Capital" checked onchange="filterTable()"> Capital</label>
                    </div>
                </div>
            </div>

            <div class="dropdown">
                <button class="dropbtn" onclick="toggleDropdown('stateDropdown')">Filter States ‚ñº</button>
                <div class="dropdown-content" id="stateDropdown">
                    <div class="checkbox-list" id="stateCheckboxes">
                        <label><input type="checkbox" value="all" checked onchange="toggleAllStates(this)"> All
                            States</label>
                        {% for s in states_data %}
                        <label onmouseover="showStateTooltip(event, '{{ s.tooltip_info }}')"
                            onmouseout="hideTooltip()"><input type="checkbox" value="{{ s.name }}" checked
                                onchange="filterTable()"> {{ s.name }}</label>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <button class="toggle-btn active" id="toggleFoodTrades" onclick="toggleFoodTrades()">Food Trade</button>
            <button class="toggle-btn active" id="toggleGoldTrades" onclick="toggleGoldTrades()">Gold Trade</button>
            <button class="toggle-btn active" id="toggleCapitals" onclick="toggleCapitals()">Highlight Capitals</button>
            <button class="toggle-btn" id="toggleStateTable" onclick="toggleStateTable()">States Table</button>
            <button class="toggle-btn" id="toggleTable" onclick="toggleTable()">Burgs Table</button>
            <button class="toggle-btn" id="toggleFoodTradeTable" onclick="toggleFoodTradeTable()">Food Trade
                Table</button>
            <button class="toggle-btn" id="toggleGoldTradeTable" onclick="toggleGoldTradeTable()">Gold Trade
                Table</button>
            <button class="toggle-btn active" id="toggleMap" onclick="toggleMap()">Show Map</button>
            <button class="toggle-btn" id="toggleMapMode" onclick="toggleMapMode()">Mode: Biome</button>
            <button class="toggle-btn special" id="toggleAdventure" onclick="toggleAdventureMode()">‚öîÔ∏è
                Adventure</button>
            <span>| Total Burgs: {{ total_burgs }}</span>
            <div id="adventureStats" class="adventure-stats" style="display:none;">
                <span title="Soldiers">üõ°Ô∏è <span id="advSoldiers">0</span></span>
                <span title="Food">üçé <span id="advFood">0</span></span>
                <span title="Gold">üí∞ <span id="advGold">0</span></span>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="map-container" id="mapContainer">
            <svg id="mapSvg" viewBox="{{ min_x-50 }} {{ min_y-50 }} {{ width }} {{ height }}"
                preserveAspectRatio="xMidYMid meet">
                <!-- Background Polygons -->
                <g id="mapBackground" class="map-background">
                    {% for p in background_paths %}
                    <path d="{{ p.d }}" fill="{{ p.fill }}" stroke="none" data-state-color="{{ p.state_fill }}"
                        data-biome-color="{{ p.biome_fill }}" data-state-id="{{ p.state_id }}" data-height="{{ p.h }}"
                        data-temp="{{ p.t }}" data-biome="{{ p.biome_name }}" data-state="{{ p.state_name }}"
                        data-cell-id="{{ p.cell_id }}" {% if p.is_water %}data-is-water="true" {% endif %}
                        onclick="selectState({{ p.state_id }})" />
                    {% endfor %}
                </g>

                <!-- Trade Routes -->
                {% for t in trade_routes %}
                <line x1="{{ t.x1 }}" y1="{{ t.y1 }}" x2="{{ t.x2 }}" y2="{{ t.y2 }}" stroke="{{ t.stroke_color }}"
                    stroke-width="1" stroke-opacity="0.6" class="trade-route {{ t.route_class }}" />
                {% endfor %}

                <!-- Burgs -->
                {% for b in burgs_data %}
                {% if b.extra_ring %}
                <circle cx="{{ b.x }}" cy="{{ b.y }}" r="{{ b.r + 3 }}" fill="none" stroke="#e74c3c" stroke-width="2"
                    class="burg-ring-gold" pointer-events="none" />
                {% endif %}
                <circle cx="{{ b.x }}" cy="{{ b.y }}" r="{{ b.r }}" fill="{{ b.color }}" stroke="{{ b.stroke }}"
                    stroke-width="{{ b.stroke_width }}" class="burg-dot{{ b.capital_class }} {{ b.dot_class_str }}"
                    data-id="{{ b.id }}" data-name="{{ b.name }}" data-pop="{{ b.population }}" data-type="{{ b.type }}"
                    data-state="{{ b.state_name }}" data-gold="{{ b.net_gold }}" data-food="{{ b.net_food }}"
                    data-quartiers="{{ b.quartier_details }}" data-cell-id="{{ b.cell_id }}">
                </circle>
                {% endfor %}
            </svg>
        </div>

        <div class="tables-wrapper">
            <!-- Order in DOM: Gold, Food, Burgs, States (because of row-reverse) -->

            <div class="trade-table-container hidden" id="goldTradeTableContainer">
                <table id="goldTradeTable">
                    <caption>Gold Trade Routes</caption>
                    <thead>
                        <tr>
                            <th onclick="sortTable(0, this, 'goldTradeTable')">From</th>
                            <th onclick="sortTable(1, this, 'goldTradeTable')">To</th>
                            <th onclick="sortTable(2, this, 'goldTradeTable')">Gold</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in gold_rows %}
                        <tr onclick="highlightTradeRoute(this, {{ row.from_id }}, {{ row.to_id }})">
                            <td>{{ row.from_name }}</td>
                            <td>{{ row.to_name }}</td>
                            <td>{{ row.amount }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="trade-table-container hidden" id="foodTradeTableContainer">
                <table id="foodTradeTable">
                    <caption>Food Trade Routes</caption>
                    <thead>
                        <tr>
                            <th onclick="sortTable(0, this, 'foodTradeTable')">From</th>
                            <th onclick="sortTable(1, this, 'foodTradeTable')">To</th>
                            <th onclick="sortTable(2, this, 'foodTradeTable')">Food</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in food_rows %}
                        <tr onclick="highlightTradeRoute(this, {{ row.from_id }}, {{ row.to_id }})">
                            <td>{{ row.from_name }}</td>
                            <td>{{ row.to_name }}</td>
                            <td>{{ row.amount }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="table-container hidden" id="burgTableContainer">
                <table id="burgTable">
                    <caption>Burgs</caption>
                    <thead>
                        <tr>
                            <th onclick="sortTable(0, this, 'burgTable')">Name</th>
                            <th onclick="sortTable(1, this, 'burgTable')">Type</th>
                            <th onclick="sortTable(2, this, 'burgTable')">State</th>
                            <th onclick="sortTable(3, this, 'burgTable')">Quartiers</th>
                            <th onclick="sortTable(4, this, 'burgTable')">Pop</th>
                            <th onclick="sortTable(5, this, 'burgTable')">Food</th>
                            <th onclick="sortTable(6, this, 'burgTable')">Gold</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for b in burgs_data %}
                        <tr data-id="{{ b.id }}" data-original-index="{{ loop.index0 }}" class="{{ b.row_class }}"
                            onclick="highlightBurg({{ b.id }})">
                            <td>{{ b.name_display }}</td>
                            <td>{{ b.type }}</td>
                            <td>{{ b.state_name }}</td>
                            <td class="quartier-cell" data-details="{{ b.quartier_details }}">{{ b.nr_quartiers }}</td>
                            <td>{{ b.population_fmt }}</td>
                            <td class="{{ 'pos' if b.net_food_val > 0 else 'neg' }}">{{ b.net_food }}</td>
                            <td class="{{ 'pos' if b.net_gold_val > 0 else 'neg' }}">{{ b.net_gold }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="state-table-container hidden" id="stateTableContainer">
                <table id="stateTable">
                    <caption>States</caption>
                    <thead>
                        <tr>
                            <th onclick="sortTable(0, this, 'stateTable')">Color</th>
                            <th onclick="sortTable(1, this, 'stateTable')">Name</th>
                            <th onclick="sortTable(2, this, 'stateTable')">Capital</th>
                            <th onclick="sortTable(3, this, 'stateTable')">Type</th>
                            <th onclick="sortTable(4, this, 'stateTable')">Culture</th>
                            <th onclick="sortTable(5, this, 'stateTable')">Burgs</th>
                            <th onclick="sortTable(6, this, 'stateTable')">Area</th>
                            <th onclick="sortTable(7, this, 'stateTable')">Cells</th>
                            <th onclick="sortTable(8, this, 'stateTable')">Form</th>
                            <th onclick="sortTable(9, this, 'stateTable')">Fullname</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for s in states_data %}
                        <tr data-original-index="{{ loop.index0 }}"
                            onclick="highlightState('{{ s.safe_name }}', '{{ s.color }}')">
                            <td><span class="color-box"
                                    style="background-color: {{ s.color }}; display: inline-block; width: 15px; height: 15px; border: 1px solid #333;"></span>
                            </td>
                            <td>{{ s.name }}</td>
                            <td>{{ s.capital_name }}</td>
                            <td>{{ s.type }}</td>
                            <td>{{ s.culture_name }}</td>
                            <td>{{ s.burgs_count }}</td>
                            <td>{{ s.area }}</td>
                            <td>{{ s.cells }}</td>
                            <td>{{ s.form }}</td>
                            <td>{{ s.fullname }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <div id="tooltip" class="tooltip"></div>

        <script>
            /* Injected Data */
            var diplomacyMatrix = {{ diplomacy_matrix }};
            var stateNameIdMap = {{ state_name_id_map }};
            var graphData = {{ graph_data }};
            var burgsData = {{ burgs_data_json }};
        </script>
        <script src="../map.js"></script>
</body>

</html>
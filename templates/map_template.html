<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Map: {{ map_name }}</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        header {
            background: #2c3e50;
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 30;
            position: relative;
        }

        h1 {
            margin: 0;
            font-size: 1.2rem;
        }

        .controls {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
        }

        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        /* Map Section */
        .map-container {
            width: 100%;
            height: 100%;
            background: #ecf0f1;
            position: relative;
            overflow: hidden;
        }

        svg {
            width: 100%;
            height: 100%;
            cursor: grab;
        }

        svg:active {
            cursor: grabbing;
        }

        .burg-dot {
            transition: r 0.2s, stroke-width 0.2s, opacity 0.3s;
            cursor: pointer;
        }

        .burg-dot:hover {
            stroke: #333;
            stroke-width: 3px;
        }

        .burg-dot.selected {
            stroke: #000;
            stroke-width: 4px;
            r: 15px;
            animation: pulse 1s infinite;
        }

        .burg-dot.highlighted {
            stroke: #000;
            stroke-width: 4px;
            r: 15px;
            animation: pulse 1s infinite;
        }

        .burg-dot.hidden {
            display: none;
        }

        /* Only show capital glow when body has show-capitals class */
        body.show-capitals .burg-dot.capital {
            filter: drop-shadow(0 0 6px gold);
        }

        .trade-route {
            pointer-events: none;
            transition: opacity 0.3s;
            opacity: 0;
        }

        /* Visibility Toggles */
        body.show-food-trades .trade-route-food {
            opacity: 1;
        }

        body.show-gold-trades .trade-route-gold {
            opacity: 1;
        }

        /* Burg Rings Toggles */
        /* Default stroke is white (defined inline or default), overrides below */

        body.show-food-trades .burg-dot.food-receiver {
            stroke: #27ae60 !important;
        }

        body.show-gold-trades .burg-dot.gold-receiver {
            stroke: #e74c3c !important;
        }

        .burg-ring-gold {
            display: none;
        }

        body.show-gold-trades .burg-ring-gold {
            display: block;
        }

        @keyframes pulse {
            0% {
                stroke-opacity: 1;
            }

            50% {
                stroke-opacity: 0.5;
            }

            100% {
                stroke-opacity: 1;
            }
        }

        /* Table Section */
        .tables-wrapper {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            display: flex;
            z-index: 20;
            pointer-events: none;
            flex-direction: row-reverse;
        }

        .table-container,
        .state-table-container,
        .trade-table-container {
            width: 800px;
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.95);
            padding: 0;
            box-shadow: -2px 0 5px rgba(0, 0, 0, 0.1);
            border-left: 1px solid #ddd;
            pointer-events: auto;
            transition: transform 0.3s ease-in-out;
        }

        .trade-table-container {
            width: 400px;
        }

        /* Stacking Order: States > Burgs > Food > Gold (Left to Right) */
        /* Since we use flex-direction: row-reverse, the first element in DOM is rightmost. */
        /* We want Gold (Rightmost) -> Food -> Burgs -> States (Leftmost) */
        /* So DOM order should be: Gold, Food, Burgs, States */

        .hidden {
            display: none !important;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        th,
        td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f8f9fa;
            position: sticky;
            top: 0;
            z-index: 1;
            cursor: pointer;
        }

        th:hover {
            background: #e9ecef;
        }

        tr:hover {
            background-color: #f1f1f1;
            cursor: pointer;
        }

        tr.selected {
            background-color: #fff3cd;
            border-left: 5px solid #f1c40f;
        }

        tr.related-highlight {
            background-color: #fff3cd;
            border-left: 5px solid #f1c40f;
        }

        tr.capital-row {
            font-weight: bold;
            background-color: #fffbf0;
        }

        /* Sort Icons */
        th.sort-asc::after {
            content: ' ▲';
        }

        th.sort-desc::after {
            content: ' ▼';
        }

        caption {
            font-weight: bold;
            padding: 10px;
            font-size: 1.1rem;
            background: #f8f9fa;
            border-bottom: 1px solid #ddd;
        }

        /* Tooltip */
        .tooltip {
            position: fixed;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            pointer-events: none;
            font-size: 0.8rem;
            display: none;
            z-index: 1000;
            max-width: 200px;
        }

        .controls input[type="text"] {
            padding: 5px;
            border-radius: 4px;
            border: 1px solid #ccc;
            margin-right: 10px;
        }

        /* Custom Dropdown */
        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropbtn {
            background-color: #34495e;
            color: white;
            padding: 5px 10px;
            font-size: 0.9rem;
            border: none;
            cursor: pointer;
            border-radius: 4px;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
            z-index: 100;
            max-height: 300px;
            overflow-y: auto;
            padding: 5px;
            border-radius: 4px;
        }

        .dropdown-content label {
            color: black;
            padding: 5px;
            display: block;
            cursor: pointer;
        }

        .dropdown-content label:hover {
            background-color: #f1f1f1;
        }

        .dropdown-content.show {
            display: block;
        }

        .dropdown:hover .dropbtn {
            background-color: #2c3e50;
        }

        /* Toggle Buttons */
        .toggle-btn {
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
            font-size: 0.9rem;
        }

        .toggle-btn:hover {
            background-color: #e0e0e0;
        }

        .toggle-btn.active {
            background-color: #3498db;
            color: white;
            border-color: #2980b9;
        }
    </style>
</head>

<body class="show-capitals show-food-trades show-gold-trades">
    <header>
        <h1>Interactive Map: {{ map_name }}</h1>
        <div class="controls">
            <input type="text" id="searchInput" onkeyup="filterTable()" placeholder="Search names...">

            <div class="dropdown">
                <button class="dropbtn" onclick="toggleDropdown('typeDropdown')">Filter Types ▼</button>
                <div class="dropdown-content" id="typeDropdown">
                    <div class="checkbox-list" id="typeCheckboxes">
                        <label><input type="checkbox" value="all" checked onchange="toggleAllTypes(this)"> All
                            Types</label>
                        {% for t in burg_types %}
                        <label><input type="checkbox" value="{{ t }}" checked onchange="filterTable()"> {{ t }}</label>
                        {% endfor %}
                        <label><input type="checkbox" value="Capital" checked onchange="filterTable()"> Capital</label>
                    </div>
                </div>
            </div>

            <div class="dropdown">
                <button class="dropbtn" onclick="toggleDropdown('stateDropdown')">Filter States ▼</button>
                <div class="dropdown-content" id="stateDropdown">
                    <div class="checkbox-list" id="stateCheckboxes">
                        <label><input type="checkbox" value="all" checked onchange="toggleAllStates(this)"> All
                            States</label>
                        {% for s in states_data %}
                        <label onmouseover="showStateTooltip(event, '{{ s.tooltip_info }}')"
                            onmouseout="hideTooltip()"><input type="checkbox" value="{{ s.name }}" checked
                                onchange="filterTable()"> {{ s.name }}</label>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <button class="toggle-btn active" id="toggleFoodTrades" onclick="toggleFoodTrades()">Food Trade</button>
            <button class="toggle-btn active" id="toggleGoldTrades" onclick="toggleGoldTrades()">Gold Trade</button>
            <button class="toggle-btn active" id="toggleCapitals" onclick="toggleCapitals()">Highlight Capitals</button>
            <button class="toggle-btn" id="toggleStateTable" onclick="toggleStateTable()">States Table</button>
            <button class="toggle-btn" id="toggleTable" onclick="toggleTable()">Burgs Table</button>
            <button class="toggle-btn" id="toggleFoodTradeTable" onclick="toggleFoodTradeTable()">Food Trade
                Table</button>
            <button class="toggle-btn" id="toggleGoldTradeTable" onclick="toggleGoldTradeTable()">Gold Trade
                Table</button>
            <button class="toggle-btn active" id="toggleMap" onclick="toggleMap()">Show Map</button>
            <button class="toggle-btn" id="toggleMapMode" onclick="toggleMapMode()">Mode: Biome</button>
            <span>| Total Burgs: {{ total_burgs }}</span>
        </div>
    </header>

    <div class="container">
        <div class="map-container" id="mapContainer">
            <svg id="mapSvg" viewBox="{{ min_x-50 }} {{ min_y-50 }} {{ width }} {{ height }}"
                preserveAspectRatio="xMidYMid meet">
                <!-- Background Polygons -->
                <g id="mapBackground" class="map-background">
                    {% for p in background_paths %}
                    <path d="{{ p.d }}" fill="{{ p.fill }}" stroke="none" data-state-color="{{ p.state_fill }}"
                        data-biome-color="{{ p.biome_fill }}" data-state-id="{{ p.state_id }}" data-height="{{ p.h }}"
                        data-temp="{{ p.t }}" data-biome="{{ p.biome_name }}" data-state="{{ p.state_name }}" {% if
                        p.is_water %}data-is-water="true" {% endif %} onclick="selectState({{ p.state_id }})" />
                    {% endfor %}
                </g>

                <!-- Trade Routes -->
                {% for t in trade_routes %}
                <line x1="{{ t.x1 }}" y1="{{ t.y1 }}" x2="{{ t.x2 }}" y2="{{ t.y2 }}" stroke="{{ t.stroke_color }}"
                    stroke-width="1" stroke-opacity="0.6" class="trade-route {{ t.route_class }}" />
                {% endfor %}

                <!-- Burgs -->
                {% for b in burgs_data %}
                {% if b.extra_ring %}
                <circle cx="{{ b.x }}" cy="{{ b.y }}" r="{{ b.r + 3 }}" fill="none" stroke="#e74c3c" stroke-width="2"
                    class="burg-ring-gold" pointer-events="none" />
                {% endif %}
                <circle cx="{{ b.x }}" cy="{{ b.y }}" r="{{ b.r }}" fill="{{ b.color }}" stroke="{{ b.stroke }}"
                    stroke-width="{{ b.stroke_width }}" class="burg-dot{{ b.capital_class }} {{ b.dot_class_str }}"
                    data-id="{{ b.id }}" data-name="{{ b.name }}" data-pop="{{ b.population }}" data-type="{{ b.type }}"
                    data-state="{{ b.state_name }}" data-gold="{{ b.net_gold }}" data-food="{{ b.net_food }}"
                    data-quartiers="{{ b.quartier_details }}">
                </circle>
                {% endfor %}
            </svg>
        </div>

        <div class="tables-wrapper">
            <!-- Order in DOM: Gold, Food, Burgs, States (because of row-reverse) -->

            <div class="trade-table-container hidden" id="goldTradeTableContainer">
                <table id="goldTradeTable">
                    <caption>Gold Trade Routes</caption>
                    <thead>
                        <tr>
                            <th onclick="sortTable(0, this, 'goldTradeTable')">From</th>
                            <th onclick="sortTable(1, this, 'goldTradeTable')">To</th>
                            <th onclick="sortTable(2, this, 'goldTradeTable')">Gold</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in gold_rows %}
                        <tr onclick="highlightTradeRoute(this, {{ row.from_id }}, {{ row.to_id }})">
                            <td>{{ row.from_name }}</td>
                            <td>{{ row.to_name }}</td>
                            <td>{{ row.amount }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="trade-table-container hidden" id="foodTradeTableContainer">
                <table id="foodTradeTable">
                    <caption>Food Trade Routes</caption>
                    <thead>
                        <tr>
                            <th onclick="sortTable(0, this, 'foodTradeTable')">From</th>
                            <th onclick="sortTable(1, this, 'foodTradeTable')">To</th>
                            <th onclick="sortTable(2, this, 'foodTradeTable')">Food</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in food_rows %}
                        <tr onclick="highlightTradeRoute(this, {{ row.from_id }}, {{ row.to_id }})">
                            <td>{{ row.from_name }}</td>
                            <td>{{ row.to_name }}</td>
                            <td>{{ row.amount }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="table-container hidden" id="burgTableContainer">
                <table id="burgTable">
                    <caption>Burgs</caption>
                    <thead>
                        <tr>
                            <th onclick="sortTable(0, this, 'burgTable')">Name</th>
                            <th onclick="sortTable(1, this, 'burgTable')">Type</th>
                            <th onclick="sortTable(2, this, 'burgTable')">State</th>
                            <th onclick="sortTable(3, this, 'burgTable')">Quartiers</th>
                            <th onclick="sortTable(4, this, 'burgTable')">Pop</th>
                            <th onclick="sortTable(5, this, 'burgTable')">Food</th>
                            <th onclick="sortTable(6, this, 'burgTable')">Gold</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for b in burgs_data %}
                        <tr data-id="{{ b.id }}" data-original-index="{{ loop.index0 }}" class="{{ b.row_class }}"
                            onclick="highlightBurg({{ b.id }})">
                            <td>{{ b.name_display }}</td>
                            <td>{{ b.type }}</td>
                            <td>{{ b.state_name }}</td>
                            <td class="quartier-cell" data-details="{{ b.quartier_details }}">{{ b.nr_quartiers }}</td>
                            <td>{{ b.population_fmt }}</td>
                            <td class="{{ 'pos' if b.net_food_val > 0 else 'neg' }}">{{ b.net_food }}</td>
                            <td class="{{ 'pos' if b.net_gold_val > 0 else 'neg' }}">{{ b.net_gold }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="state-table-container hidden" id="stateTableContainer">
                <table id="stateTable">
                    <caption>States</caption>
                    <thead>
                        <tr>
                            <th onclick="sortTable(0, this, 'stateTable')">Color</th>
                            <th onclick="sortTable(1, this, 'stateTable')">Name</th>
                            <th onclick="sortTable(2, this, 'stateTable')">Capital</th>
                            <th onclick="sortTable(3, this, 'stateTable')">Type</th>
                            <th onclick="sortTable(4, this, 'stateTable')">Culture</th>
                            <th onclick="sortTable(5, this, 'stateTable')">Burgs</th>
                            <th onclick="sortTable(6, this, 'stateTable')">Area</th>
                            <th onclick="sortTable(7, this, 'stateTable')">Cells</th>
                            <th onclick="sortTable(8, this, 'stateTable')">Form</th>
                            <th onclick="sortTable(9, this, 'stateTable')">Fullname</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for s in states_data %}
                        <tr data-original-index="{{ loop.index0 }}"
                            onclick="highlightState('{{ s.safe_name }}', '{{ s.color }}')">
                            <td><span class="color-box"
                                    style="background-color: {{ s.color }}; display: inline-block; width: 15px; height: 15px; border: 1px solid #333;"></span>
                            </td>
                            <td>{{ s.name }}</td>
                            <td>{{ s.capital_name }}</td>
                            <td>{{ s.type }}</td>
                            <td>{{ s.culture_name }}</td>
                            <td>{{ s.burgs_count }}</td>
                            <td>{{ s.area }}</td>
                            <td>{{ s.cells }}</td>
                            <td>{{ s.form }}</td>
                            <td>{{ s.fullname }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <div id="tooltip" class="tooltip"></div>

        <script>
            const svg = document.getElementById('mapSvg');
            const tooltip = document.getElementById('tooltip');
            const mapContainer = document.getElementById('mapContainer');
            const table = document.getElementById('burgTable');
            let selectedId = null;
            let highlightedIds = [];

            /* Dropdown Logic */
            function toggleDropdown(id) {
                document.getElementById(id).classList.toggle("show");
            }

            function showStateTooltip(e, content) {
                const tooltip = document.getElementById('tooltip');
                tooltip.innerHTML = content;
                tooltip.style.display = 'block';

                // Position near the cursor
                let left = e.clientX + 15;
                let top = e.clientY + 15;

                // Adjust if going off screen
                if (left + 220 > window.innerWidth) {
                    left = e.clientX - 230;
                }

                if (top + 150 > window.innerHeight) {
                    top = e.clientY - 160;
                }

                tooltip.style.left = left + 'px';
                tooltip.style.top = top + 'px';
            }

            function hideTooltip() {
                const tooltip = document.getElementById('tooltip');
                tooltip.style.display = 'none';
            }

            function toggleFoodTrades() {
                const btn = document.getElementById('toggleFoodTrades');
                btn.classList.toggle('active');
                if (btn.classList.contains('active')) {
                    document.body.classList.add('show-food-trades');
                } else {
                    document.body.classList.remove('show-food-trades');
                }
            }

            function toggleGoldTrades() {
                const btn = document.getElementById('toggleGoldTrades');
                btn.classList.toggle('active');
                if (btn.classList.contains('active')) {
                    document.body.classList.add('show-gold-trades');
                } else {
                    document.body.classList.remove('show-gold-trades');
                }
            }

            function toggleCapitals() {
                const btn = document.getElementById('toggleCapitals');
                btn.classList.toggle('active');
                if (btn.classList.contains('active')) {
                    document.body.classList.add('show-capitals');
                } else {
                    document.body.classList.remove('show-capitals');
                }
            }

            function toggleTable() {
                const btn = document.getElementById('toggleTable');
                const container = document.getElementById('burgTableContainer');
                btn.classList.toggle('active');
                if (btn.classList.contains('active')) {
                    container.classList.remove('hidden');
                } else {
                    container.classList.add('hidden');
                }
                window.dispatchEvent(new Event('resize'));
            }

            function toggleStateTable() {
                const btn = document.getElementById('toggleStateTable');
                const container = document.getElementById('stateTableContainer');
                btn.classList.toggle('active');
                if (btn.classList.contains('active')) {
                    container.classList.remove('hidden');
                } else {
                    container.classList.add('hidden');
                }
                window.dispatchEvent(new Event('resize'));
            }

            function toggleFoodTradeTable() {
                const btn = document.getElementById('toggleFoodTradeTable');
                const container = document.getElementById('foodTradeTableContainer');
                btn.classList.toggle('active');
                if (btn.classList.contains('active')) {
                    container.classList.remove('hidden');
                } else {
                    container.classList.add('hidden');
                }
                window.dispatchEvent(new Event('resize'));
            }

            /* Injected Data */
            const diplomacyMatrix = {{ diplomacy_matrix }};
            const stateNameIdMap = {{ state_name_id_map }};
            const relationColors = {
                "Ally": "#32CD32",      // Lime Green
                "Friendly": "#90EE90",  // Light Green
                "Neutral": "#D3D3D3",   // Light Grey
                "Suspicion": "#FFA500", // Orange
                "Enemy": "#FF4500",     // Orange Red
                "War": "#FF0000",       // Red
                "Vassal": "#87CEEB",    // Sky Blue
                "Suzerain": "#C8A2C8",  // Lilac
                "Unknown": "#F5F5F5",   // White Smoke
                "x": "#800080"          // Selected State (Purple)
            };

            function toggleGoldTradeTable() {
                const btn = document.getElementById('toggleGoldTradeTable');
                const container = document.getElementById('goldTradeTableContainer');
                btn.classList.toggle('active');
                if (btn.classList.contains('active')) {
                    container.classList.remove('hidden');
                } else {
                    container.classList.add('hidden');
                }
                window.dispatchEvent(new Event('resize'));
            }

            function toggleMap() {
                const btn = document.getElementById('toggleMap');
                const mapGroup = document.getElementById('mapBackground');
                btn.classList.toggle('active');
                if (btn.classList.contains('active')) {
                    mapGroup.style.display = 'block';
                } else {
                    mapGroup.style.display = 'none';
                }
            }

            function toggleMapMode() {
                const btn = document.getElementById('toggleMapMode');
                const paths = document.querySelectorAll('#mapBackground path');

                // Use data attribute for state tracking
                const currentMode = btn.getAttribute('data-mode') || 'biome';

                if (currentMode === 'biome') {
                    // Switch to State
                    btn.innerText = 'Mode: State';
                    btn.setAttribute('data-mode', 'state');
                    paths.forEach(p => {
                        p.setAttribute('fill', p.getAttribute('data-state-color'));
                    });
                } else if (currentMode === 'state') {
                    // Switch to Heightmap
                    btn.innerText = 'Mode: Heightmap';
                    btn.setAttribute('data-mode', 'heightmap');

                    paths.forEach(p => {
                        // Heightmap logic: darken color based on height
                        let h = parseInt(p.getAttribute('data-height'));
                        let c = 255 - h * 2;
                        if (c < 0) c = 0;
                        if (p.getAttribute('data-is-water') === 'true') {
                            p.setAttribute('fill', `rgb(${c / 2}, ${c / 2}, ${200 + h / 2})`);
                        } else {
                            p.setAttribute('fill', `rgb(${c}, ${c}, ${c})`);
                        }
                    });
                } else if (currentMode === 'heightmap') {
                    // Switch to Temperature
                    btn.innerText = 'Mode: Temperature';
                    btn.setAttribute('data-mode', 'temperature');
                    paths.forEach(p => {
                        const t = parseInt(p.getAttribute('data-temp'));
                        p.setAttribute('fill', getColorForTemp(t));
                    });
                } else {
                    // Switch to Biome
                    btn.innerText = 'Mode: Biome';
                    btn.setAttribute('data-mode', 'biome');
                    paths.forEach(p => {
                        p.setAttribute('fill', p.getAttribute('data-biome-color'));
                    });
                }
            }

            function getColorForHeight(h) {
                // Azgaar height range: 0-100 (usually)
                // Water: < 20
                // Land: >= 20

                if (h < 20) {
                    // Water: Uniform Deep Blue
                    return "#000080";
                } else {
                    // Land gradient: Green -> Yellow -> Brown -> White
                    if (h < 40) return "#228B22"; // Forest Green (Lowlands)
                    if (h < 60) return "#9ACD32"; // Yellow Green (Hills)
                    if (h < 80) return "#CD853F"; // Peru (Mountains)
                    return "#FFFFFF"; // White (Peaks)
                }
            }

            function getColorForTemp(t) {
                // Range: approx -30 to 50 (Celsius)
                // Hot (> 30): Red
                // Warm (20-30): Orange
                // Temperate (10-20): Yellow/Green
                // Cool (0-10): Cyan
                // Cold (-10 to 0): Blue
                // Freezing (< -10): Purple

                if (t < -10) return "#4B0082"; // Indigo (Deep Freeze)
                if (t < -5) return "#800080"; // Purple (Freezing)
                if (t < 0) return "#0000FF"; // Blue (Cold)
                if (t < 5) return "#00BFFF"; // Deep Sky Blue (Cool)
                if (t < 10) return "#ADFF2F"; // Green Yellow (Temperate)
                if (t < 15) return "#FFD700"; // Gold (Warm)
                if (t < 20) return "#FF8C00"; // Dark Orange (Hot)
                return "#FF0000"; // Red (Scorching)
            }

            function selectState(stateId) {
                const btn = document.getElementById('toggleMapMode');
                const currentMode = btn.getAttribute('data-mode');

                if (currentMode === 'state') {
                    updateDiplomacyColors(stateId);
                }
            }

            function updateDiplomacyColors(stateIdentifier) {
                let stateId = null;

                // Try to find state ID
                if (typeof stateIdentifier === 'number') {
                    stateId = stateIdentifier;
                } else if (typeof stateIdentifier === 'string') {
                    if (stateNameIdMap.hasOwnProperty(stateIdentifier)) {
                        stateId = stateNameIdMap[stateIdentifier];
                    }
                }

                // FIX: Treat selecting "Neutral" (0) as deselecting
                if (stateId === 0) stateId = null;

                const paths = document.querySelectorAll('#mapBackground path');

                if (stateId !== null && diplomacyMatrix[stateId]) {
                    const relations = diplomacyMatrix[stateId];

                    paths.forEach(p => {
                        const isWater = p.hasAttribute('data-is-water');
                        if (isWater) {
                            p.setAttribute('fill', '#333333'); // Dark Gray for water
                        } else {
                            const pStateId = parseInt(p.getAttribute('data-state-id'));

                            // FIX: Explicitly handle Neutrals (ID 0)
                            if (pStateId === 0 && stateId !== 0) {
                                p.setAttribute('fill', '#ffffff'); // White for Neutrals
                            } else if (!isNaN(pStateId) && pStateId < relations.length) {
                                const relation = relations[pStateId];
                                // Highlight self differently?
                                let color = relationColors[relation] || relationColors['Unknown'];
                                if (pStateId === stateId) color = relationColors['x'];

                                p.setAttribute('fill', color);
                            }
                        }
                    });
                } else {
                    // Reset to State Colors if no state selected
                    paths.forEach(p => {
                        const isWater = p.hasAttribute('data-is-water');
                        if (isWater) {
                            p.setAttribute('fill', '#333333'); // Dark Gray
                        } else {
                            // Revert to state color
                            p.setAttribute('fill', p.getAttribute('data-state-color'));
                        }
                    });
                }
            }

            function toggleAllStates(source) {
                const checkboxes = document.querySelectorAll('#stateCheckboxes input[type="checkbox"]');
                for (var i = 0, n = checkboxes.length; i < n; i++) {
                    checkboxes[i].checked = source.checked;
                }
                filterTable();
            }

            // COPY-PASTED HELPER FUNCTIONS TO ENSURE FUNCTIONALITY
            function filterTable() {
                const searchInput = document.getElementById('searchInput');
                const filterText = searchInput.value.toLowerCase();

                // Get selected types
                const typeCheckboxes = document.querySelectorAll('#typeCheckboxes input[type="checkbox"]');
                const selectedTypes = [];

                typeCheckboxes.forEach(cb => {
                    if (cb.value !== 'all' && cb.checked) {
                        selectedTypes.push(cb.value);
                    }
                });

                // Get selected states
                const stateCheckboxes = document.querySelectorAll('#stateCheckboxes input[type="checkbox"]');
                const selectedStates = [];

                stateCheckboxes.forEach(cb => {
                    if (cb.value !== 'all' && cb.checked) {
                        selectedStates.push(cb.value);
                    }
                });

                const rows = table.getElementsByTagName('tr');

                // Filter Table
                // Start from 1 to skip header
                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i];
                    const nameCell = row.getElementsByTagName('td')[0];
                    const typeCell = row.getElementsByTagName('td')[1];
                    const stateCell = row.getElementsByTagName('td')[2];
                    const burgId = row.getAttribute('data-id');

                    if (nameCell && typeCell && stateCell) {
                        const nameText = nameCell.textContent || nameCell.innerText;
                        const typeText = typeCell.textContent || typeCell.innerText;
                        const stateText = stateCell.textContent || stateCell.innerText;
                        const isCapitalRow = row.classList.contains('capital-row');

                        const matchesName = nameText.toLowerCase().indexOf(filterText) > -1;

                        // Check if type matches ANY of the selected types
                        let matchesType = false;
                        if (selectedTypes.includes(typeText)) {
                            matchesType = true;
                        }
                        if (selectedTypes.includes('Capital') && isCapitalRow) {
                            matchesType = true;
                        }

                        // Check if state matches ANY of the selected states
                        let matchesState = false;
                        if (selectedStates.includes(stateText)) {
                            matchesState = true;
                        }

                        const isVisible = matchesName && matchesType && matchesState;

                        if (isVisible) {
                            row.style.display = "";
                        } else {
                            row.style.display = "none";
                        }

                        // Filter Map Dot corresponding to this row
                        const dot = document.querySelector(`.burg-dot[data-id="${burgId}"]`);
                        if (dot) {
                            if (isVisible) {
                                dot.classList.remove('hidden');
                            } else {
                                dot.classList.add('hidden');
                            }
                        }
                    }
                }

                // Filter State Table
                const stateTable = document.getElementById('stateTable');
                if (stateTable) {
                    const stateRows = stateTable.getElementsByTagName('tr');
                    // Start from 1 to skip header
                    for (let i = 1; i < stateRows.length; i++) {
                        const row = stateRows[i];
                        const nameCell = row.getElementsByTagName('td')[1]; // Name is 2nd column

                        if (nameCell) {
                            const stateName = nameCell.textContent || nameCell.innerText;

                            // Check if state matches ANY of the selected states
                            let matchesState = false;
                            if (selectedStates.includes(stateName)) {
                                matchesState = true;
                            }

                            // Check search text against state name
                            const matchesSearch = stateName.toLowerCase().indexOf(filterText) > -1;

                            if (matchesState && matchesSearch) {
                                row.style.display = "";
                            } else {
                                row.style.display = "none";
                            }
                        }
                    }
                }
            }

            function toggleAllTypes(source) {
                const checkboxes = document.querySelectorAll('#typeCheckboxes input');
                for (let i = 0; i < checkboxes.length; i++) {
                    checkboxes[i].checked = source.checked;
                }
                filterTable();
            }

            // Map Interactions
            svg.addEventListener('click', (e) => {
                if (e.target.classList.contains('burg-dot')) {
                    const id = e.target.getAttribute('data-id');
                    selectBurg(id);
                } else {
                    // Deselect if clicking empty space
                    // selectBurg(null);
                }
            });

            svg.addEventListener('mousemove', (e) => {
                if (e.target.classList.contains('burg-dot')) {
                    const name = e.target.getAttribute('data-name');
                    const pop = parseInt(e.target.getAttribute('data-pop')).toLocaleString();
                    const type = e.target.getAttribute('data-type');
                    const state = e.target.getAttribute('data-state');
                    const gold = e.target.getAttribute('data-gold');
                    const food = e.target.getAttribute('data-food');
                    const quartiers = e.target.getAttribute('data-quartiers');
                    const isCapital = e.target.classList.contains('capital');

                    let displayName = isCapital ? `★ ${name}` : name;

                    let tooltipContent = `<strong>${displayName}</strong><br>State: ${state}<br>Type: ${type}<br>Pop: ${pop}<br>Food: ${food}<br>Gold: ${gold}`;
                    if (quartiers) {
                        tooltipContent += `<hr style="margin: 5px 0; border: 0; border-top: 1px solid rgba(255,255,255,0.3);">${quartiers}`;
                    }

                    tooltip.innerHTML = tooltipContent;
                    tooltip.style.display = 'block';

                    // Smart positioning to keep within viewport
                    let top = e.clientY + 10;
                    let left = e.clientX + 10;

                    // Check if tooltip goes off bottom
                    if (top + 100 > window.innerHeight) {
                        top = e.clientY - 100; // Move above cursor
                    }

                    tooltip.style.left = left + 'px';
                    tooltip.style.top = top + 'px';
                } else if (e.target.tagName === 'path') {
                    const btn = document.getElementById('toggleMapMode');
                    const mode = btn.getAttribute('data-mode') || 'biome';

                    let content = '';
                    if (mode === 'biome') {
                        const biome = e.target.getAttribute('data-biome');
                        if (biome) content = `<strong>Biome:</strong> ${biome}`;
                    } else if (mode === 'state') {
                        const state = e.target.getAttribute('data-state');
                        if (state) content = `<strong>State:</strong> ${state}`;
                    } else if (mode === 'heightmap') {
                        const h = e.target.getAttribute('data-height');
                        if (h) content = `<strong>Height:</strong> ${h}`;
                    } else if (mode === 'temperature') {
                        const t = e.target.getAttribute('data-temp');
                        if (t) content = `<strong>Temp:</strong> ${t}°C`;
                    }

                    if (content) {
                        tooltip.innerHTML = content;
                        tooltip.style.display = 'block';
                        tooltip.style.left = (e.clientX + 15) + 'px';
                        tooltip.style.top = (e.clientY + 15) + 'px';
                    } else {
                        tooltip.style.display = 'none';
                    }
                } else {
                    tooltip.style.display = 'none';
                }
            });

            // Table Tooltip Interactions
            table.addEventListener('mousemove', (e) => {
                if (e.target.classList.contains('quartier-cell')) {
                    const details = e.target.getAttribute('data-details');
                    if (details) {
                        tooltip.innerHTML = details;
                        tooltip.style.display = 'block';
                        tooltip.style.left = (e.clientX + 10) + 'px';
                        tooltip.style.top = (e.clientY + 10) + 'px';
                    }
                } else {
                    // Only hide if not over map dot (which is separate)
                    // But we are in table container, so map tooltip is not active
                    tooltip.style.display = 'none';
                }
            });

            table.addEventListener('mouseleave', () => {
                tooltip.style.display = 'none';
            });

            // Pan and Zoom (Basic)
            let isPanning = false;
            let startX, startY;
            let viewBox = svg.getAttribute('viewBox').split(' ').map(parseFloat);

            mapContainer.addEventListener('mousedown', (e) => {
                if (e.target === svg || e.target.tagName === 'circle' || e.target.tagName === 'line' || e.target.tagName === 'path') {
                    isPanning = true;
                    startX = e.clientX;
                    startY = e.clientY;
                    mapContainer.style.cursor = 'grabbing';
                }
            });

            mapContainer.addEventListener('mousemove', (e) => {
                if (!isPanning) return;
                e.preventDefault();
                const dx = (e.clientX - startX) * (viewBox[2] / mapContainer.clientWidth);
                const dy = (e.clientY - startY) * (viewBox[3] / mapContainer.clientHeight);

                viewBox[0] -= dx;
                viewBox[1] -= dy;
                svg.setAttribute('viewBox', viewBox.join(' '));

                startX = e.clientX;
                startY = e.clientY;
            });

            mapContainer.addEventListener('mouseup', () => {
                isPanning = false;
                mapContainer.style.cursor = 'default';
            });

            mapContainer.addEventListener('mouseleave', () => {
                isPanning = false;
                mapContainer.style.cursor = 'default';
            });

            mapContainer.addEventListener('wheel', (e) => {
                e.preventDefault();
                const scale = e.deltaY > 0 ? 1.1 : 0.9;
                const w = viewBox[2];
                const h = viewBox[3];

                viewBox[2] *= scale;
                viewBox[3] *= scale;

                // Zoom towards center
                viewBox[0] -= (viewBox[2] - w) / 2;
                viewBox[1] -= (viewBox[3] - h) / 2;

                svg.setAttribute('viewBox', viewBox.join(' '));
            });

            function selectBurg(id) {
                // Remove previous selection
                if (selectedId) {
                    const prevRow = document.querySelector(`tr[data-id="${selectedId}"]`);
                    const prevDot = document.querySelector(`.burg-dot[data-id="${selectedId}"]`);
                    if (prevRow) prevRow.classList.remove('selected');
                    if (prevDot) prevDot.classList.remove('selected');
                }

                // Clear any trade route highlights
                clearHighlights();

                // Clear previous table highlights (State and Trade)
                document.querySelectorAll('.related-highlight').forEach(el => el.classList.remove('selected'));

                selectedId = id;

                if (id) {
                    const row = document.querySelector(`tr[data-id="${id}"]`);
                    const dot = document.querySelector(`.burg-dot[data-id="${id}"]`);

                    if (row) {
                        row.classList.add('selected');
                        row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }

                    if (dot) {
                        dot.classList.add('selected');

                        // Highlight Related State
                        const stateName = dot.getAttribute('data-state');
                        if (stateName) {
                            // Update Diplomacy Map if active
                            const btn = document.getElementById('toggleMapMode');
                            if (btn && btn.getAttribute('data-mode') === 'state') {
                                updateDiplomacyColors(stateName);
                            }

                            const stateTable = document.getElementById('stateTable');
                            const stateRows = stateTable.getElementsByTagName('tr');
                            for (let i = 1; i < stateRows.length; i++) {
                                const sRow = stateRows[i];
                                const nameCell = sRow.getElementsByTagName('td')[1]; // Name is 2nd column
                                if (nameCell && (nameCell.textContent || nameCell.innerText).trim() === stateName) {
                                    sRow.classList.add('related-highlight');
                                    sRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                    break;
                                }
                            }
                        }

                        // Highlight Related Trade Routes
                        const burgName = dot.getAttribute('data-name');
                        if (burgName) {
                            ['foodTradeTable', 'goldTradeTable'].forEach(tableId => {
                                let scrolled = false;
                                const tTable = document.getElementById(tableId);
                                if (tTable) {
                                    const tRows = tTable.getElementsByTagName('tr');
                                    for (let i = 1; i < tRows.length; i++) {
                                        const tRow = tRows[i];
                                        const fromCell = tRow.getElementsByTagName('td')[0];
                                        const toCell = tRow.getElementsByTagName('td')[1];

                                        const fromName = (fromCell.textContent || fromCell.innerText).trim();
                                        const toName = (toCell.textContent || toCell.innerText).trim();

                                        if (fromName === burgName || toName === burgName) {
                                            tRow.classList.add('related-highlight');
                                            if (!scrolled) {
                                                tRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                                scrolled = true;
                                            }
                                        }
                                    }
                                }
                            });
                        }
                    }
                }
            }

            function highlightBurg(id) {
                selectBurg(id);
            }

            function clearHighlights() {
                // Clear Burg Dots
                document.querySelectorAll('.burg-dot').forEach(el => {
                    el.classList.remove('selected', 'highlighted');
                    el.style.fill = '';
                    el.style.stroke = '';
                });

                // Clear Table Rows (Burgs, States, Trades)
                document.querySelectorAll('tr').forEach(el => {
                    el.classList.remove('selected', 'related-highlight');
                });

                highlightedIds = [];
                selectedId = null;
            }

            function highlightState(stateName, color) {
                clearHighlights();

                // Find and highlight state row
                const stateTable = document.getElementById('stateTable');
                if (stateTable) {
                    const stateRows = stateTable.getElementsByTagName('tr');
                    for (let i = 1; i < stateRows.length; i++) {
                        const sRow = stateRows[i];
                        const nameCell = sRow.getElementsByTagName('td')[1];
                        if (nameCell && (nameCell.textContent || nameCell.innerText).trim() === stateName) {
                            sRow.classList.add('selected');
                            break;
                        }
                    }
                }

                const burgsInState = [];
                let firstBurgScrolled = false;

                // Highlight Burg Dots and accumulate names
                const dots = document.querySelectorAll(`.burg-dot[data-state="${stateName}"]`);
                dots.forEach(dot => {
                    dot.classList.add('highlighted');
                    dot.style.fill = color;
                    dot.style.stroke = '#000';

                    const id = dot.getAttribute('data-id');
                    const name = dot.getAttribute('data-name');
                    if (id) {
                        highlightedIds.push(id);
                        // Highlight Burg Row
                        const row = document.querySelector(`tr[data-id="${id}"]`);
                        if (row) {
                            row.classList.add('related-highlight');
                            if (!firstBurgScrolled) {
                                row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                firstBurgScrolled = true;
                            }
                        }
                    }
                    if (name) burgsInState.push(name);
                });

                // Highlight Trade Routes
                if (burgsInState.length > 0) {
                    ['foodTradeTable', 'goldTradeTable'].forEach(tableId => {
                        let firstTradeScrolled = false;
                        const tTable = document.getElementById(tableId);
                        if (tTable) {
                            const tRows = tTable.getElementsByTagName('tr');
                            for (let i = 1; i < tRows.length; i++) {
                                const tRow = tRows[i];
                                const fromCell = tRow.getElementsByTagName('td')[0];
                                const toCell = tRow.getElementsByTagName('td')[1];

                                const fromName = (fromCell.textContent || fromCell.innerText).trim();
                                const toName = (toCell.textContent || toCell.innerText).trim();

                                if (burgsInState.includes(fromName) || burgsInState.includes(toName)) {
                                    tRow.classList.add('related-highlight');
                                    if (!firstTradeScrolled) {
                                        tRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                        firstTradeScrolled = true;
                                    }
                                }
                            }
                        }
                    });
                }
            }

            function highlightTradeRoute(el, fromId, toId) {
                clearHighlights();
                if (selectedId) selectBurg(null); // Reset single burg selection mode

                // 1. Highlight the Trade Route Row(s)
                if (el) el.classList.add('selected');

                // 2. Identify and Highlight Burgs (Dots and Rows)
                const burgIds = [fromId, toId];
                const stateNames = new Set();

                burgIds.forEach(id => {
                    // Highlight Dot
                    const dot = document.querySelector(`.burg-dot[data-id="${id}"]`);
                    if (dot) {
                        dot.classList.add('selected');
                        highlightedIds.push(id);

                        const sName = dot.getAttribute('data-state');
                        if (sName) stateNames.add(sName);
                    }

                    // Highlight Row
                    const row = document.querySelector(`tr[data-id="${id}"]`);
                    if (row) {
                        row.classList.add('selected');
                        row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                });

                // 3. Highlight States
                const stateTable = document.getElementById('stateTable');
                if (stateTable && stateNames.size > 0) {
                    const stateRows = stateTable.getElementsByTagName('tr');
                    let firstStateScrolled = false;
                    for (let i = 1; i < stateRows.length; i++) {
                        const sRow = stateRows[i];
                        const nameCell = sRow.getElementsByTagName('td')[1];
                        const rowStateName = (nameCell.textContent || nameCell.innerText).trim();

                        if (nameCell && stateNames.has(rowStateName)) {
                            sRow.classList.add('related-highlight');
                            if (!firstStateScrolled) {
                                sRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                firstStateScrolled = true;
                            }
                        }
                    }
                }
            }

            function sortTable(n, header, tableId) {
                const table = document.getElementById(tableId);
                let dir = "asc";

                // Reset other headers
                const headers = table.querySelectorAll('th');
                headers.forEach(h => {
                    if (h !== header) {
                        h.classList.remove('sort-asc', 'sort-desc');
                    }
                });

                // Determine sort direction (Tri-state: Asc -> Desc -> Original)
                if (header.classList.contains('sort-asc')) {
                    dir = "desc";
                    header.classList.remove('sort-asc');
                    header.classList.add('sort-desc');
                } else if (header.classList.contains('sort-desc')) {
                    dir = "original";
                    header.classList.remove('sort-desc');
                } else {
                    dir = "asc";
                    header.classList.add('sort-asc');
                }

                // Optimization: Sort an array of rows instead of DOM manipulation
                const tbody = table.querySelector('tbody');
                const rowsArray = Array.from(tbody.rows);

                rowsArray.sort((a, b) => {
                    // If reverting to original order
                    if (dir === "original") {
                        let xIndex = parseInt(a.getAttribute('data-original-index'));
                        let yIndex = parseInt(b.getAttribute('data-original-index'));
                        return xIndex - yIndex;
                    }

                    let x = a.getElementsByTagName("TD")[n];
                    let y = b.getElementsByTagName("TD")[n];

                    let xContent = x.textContent || x.innerText;
                    let yContent = y.textContent || y.innerText;

                    // Handle "★ " prefix
                    xContent = xContent.replace("★ ", "");
                    yContent = yContent.replace("★ ", "");

                    // Check if numeric (remove commas)
                    let xNum = parseFloat(xContent.replace(/,/g, ""));
                    let yNum = parseFloat(yContent.replace(/,/g, ""));

                    if (!isNaN(xNum) && !isNaN(yNum)) {
                        return dir === "asc" ? xNum - yNum : yNum - xNum;
                    } else {
                        return dir === "asc" ? xContent.localeCompare(yContent) : yContent.localeCompare(xContent);
                    }
                });

                // Re-append sorted rows
                const fragment = document.createDocumentFragment();
                rowsArray.forEach(row => fragment.appendChild(row));
                tbody.appendChild(fragment);
            }
        </script>
</body>

</html>